#! /usr/bin/env bash

./gradlew init
./gradlew build
./gradlew test

docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD";

docker pull cshr/lpg-learner-record || true

docker build --cache-from cshr/lpg-learner-record:latest -t cshr/lpg-learner-record:${TRAVIS_COMMIT} .

export BRANCH_TAG=`echo ${TRAVIS_PULL_REQUEST_BRANCH:-TRAVIS_BRANCH} | sed 's/\//-/g'`

docker tag cshr/lpg-learner-record:${TRAVIS_COMMIT} cshr/lpg-learner-record:${BRANCH_TAG}
docker tag cshr/lpg-learner-record:${TRAVIS_COMMIT} cshr/lpg-learner-record:latest

docker push cshr/lpg-learner-record
